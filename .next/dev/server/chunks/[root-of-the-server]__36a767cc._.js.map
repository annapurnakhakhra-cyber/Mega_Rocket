{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/lib/db.js"],"sourcesContent":["\r\n// /lib/db.js\r\nimport mongoose from \"mongoose\";\r\n\r\nlet isConnected = false;\r\n\r\nexport default async function connectDB() {\r\n  if (isConnected) return;\r\n\r\n  if (!process.env.MONGODB_URI) {\r\n    throw new Error(\"❌ MONGODB_URI is missing in .env.local\");\r\n  }\r\n\r\n  try {\r\n    const db = await mongoose.connect(process.env.MONGODB_URI, {\r\n      dbName: \"shopify-app\",\r\n    });\r\n    isConnected = db.connections[0].readyState === 1;\r\n    console.log(\"✅ Database connected\");\r\n  } catch (err) {\r\n    console.error(\"❌ Database connection error:\", err);\r\n    throw err;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AACA,aAAa;;;;;AACb;;AAEA,IAAI,cAAc;AAEH,eAAe;IAC5B,IAAI,aAAa;IAEjB,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;QAC5B,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,MAAM,KAAK,MAAM,oHAAQ,CAAC,OAAO,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;YACzD,QAAQ;QACV;QACA,cAAc,GAAG,WAAW,CAAC,EAAE,CAAC,UAAU,KAAK;QAC/C,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/models/User.js"],"sourcesContent":["\r\nimport mongoose from \"mongoose\";\r\n\r\nconst UserSchema = new mongoose.Schema(\r\n  {\r\n    adminName: String,\r\n    email: { type: String, unique: true },\r\n    shopName: String,\r\n    shopUrl: String,\r\n    accessToken: String,\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nexport default mongoose.models.User || mongoose.model(\"User\", UserSchema);\r\n\r\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CACpC;IACE,WAAW;IACX,OAAO;QAAE,MAAM;QAAQ,QAAQ;IAAK;IACpC,UAAU;IACV,SAAS;IACT,aAAa;AACf,GACA;IAAE,YAAY;AAAK;uCAGN,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ"}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/lib/jwt.js"],"sourcesContent":["\r\n\r\n\r\n\r\nimport jwt from \"jsonwebtoken\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"your_super_secret_key\";\r\n\r\n// Generate a token\r\nexport function signToken(payload, expiresIn = \"1h\") {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn });\r\n}\r\n\r\n// Verify a token\r\nexport function verifyToken(token) {\r\n  try {\r\n    return jwt.verify(token, JWT_SECRET);\r\n  } catch (err) {\r\n    return null;\r\n  }\r\n}\r\n  "],"names":[],"mappings":";;;;;;AAIA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAGtC,SAAS,UAAU,OAAO,EAAE,YAAY,IAAI;IACjD,OAAO,gKAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE;IAAU;AACnD;AAGO,SAAS,YAAY,KAAK;IAC/B,IAAI;QACF,OAAO,gKAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,KAAK;QACZ,OAAO;IACT;AACF"}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/app/api/dashboard/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\n\r\nimport connectToDB from \"@/lib/db\";\r\nimport User from \"@/models/User\";\r\nimport { verifyToken } from \"@/lib/jwt\";\r\nimport fetch from \"node-fetch\";\r\n\r\nexport async function GET(req) {\r\n  await connectToDB();\r\n\r\n  const authHeader = req.headers.get(\"authorization\");\r\n  if (!authHeader)\r\n    return new Response(JSON.stringify({ error: \"Unauthorized\" }), { status: 401 });\r\n\r\n  const token = authHeader.split(\" \")[1];\r\n  const decoded = verifyToken(token);\r\n  if (!decoded)\r\n    return new Response(JSON.stringify({ error: \"Invalid token\" }), { status: 401 });\r\n\r\n  console.log(decoded)\r\n\r\n  // Fetch admin from users collection\r\n  const admin = await User.findOne({ email: decoded.email.trim() })\r\n\r\n  console.log(\"Decoded token:\", admin);\r\n\r\n  if (!admin) {\r\n    console.log(\"Admin not found for email:\", decoded.email);\r\n    return new Response(JSON.stringify({ error: \"Admin not found\" }), { status: 404 });\r\n  }\r\n\r\n  if (!admin.accessToken || !admin.shopUrl) {\r\n    console.log(\"Admin credentials missing:\", admin);\r\n    return new Response(JSON.stringify({ error: \"Shopify credentials missing\" }), { status: 400 });\r\n  }\r\n\r\n  const SHOPIFY_URL = `https://${admin.shopUrl}/admin/api/2025-10`;\r\n\r\n  try {\r\n    // Fetch recent customers\r\n    const customerRes = await fetch(`${SHOPIFY_URL}/graphql.json`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"X-Shopify-Access-Token\": admin.accessToken,\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        query: `\r\n          {\r\n            customers(first: 10, sortKey: CREATED_AT, reverse: true) {\r\n              edges { node { id email firstName lastName createdAt } }\r\n            }\r\n          }\r\n        `,\r\n      }),\r\n    });\r\n\r\n    const customerJson = await customerRes.json();\r\n    const recentCustomers = customerJson.data?.customers?.edges?.map(e => e.node) || [];\r\n\r\n    // Fetch orders\r\n    const ordersRes = await fetch(`${SHOPIFY_URL}/orders.json`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"X-Shopify-Access-Token\": admin.accessToken,\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    const ordersData = await ordersRes.json();\r\n    const orders = Array.isArray(ordersData.orders) ? ordersData.orders : [];\r\n\r\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\r\n\r\n    const recentOrders = orders.filter(order => new Date(order.created_at) >= thirtyDaysAgo);\r\n\r\n    const prepaidCount = orders.filter(o => o.financial_status === \"paid\").length;\r\n    const pendingCount = orders.filter(o => o.financial_status === \"pending\").length;\r\n\r\n    // Fetch refunds\r\n    const refunds = [];\r\n    for (const order of recentOrders.slice(0, 10)) {\r\n      if (order.refunds?.length) {\r\n        order.refunds.forEach(refund => {\r\n          refunds.push({\r\n            id: refund.id,\r\n            orderId: order.id,\r\n            orderName: order.name,\r\n            amount: refund.total_refunded_amount || refund.amount,\r\n            createdAt: refund.created_at,\r\n          });\r\n        });\r\n      }\r\n    }\r\n\r\n    refunds.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\r\n\r\n    const dashboard = {\r\n      customers: {\r\n        total: recentCustomers.length > 0 ? \"100+\" : recentCustomers.length,\r\n        recent: recentCustomers,\r\n      },\r\n      orders: {\r\n        total: orders.length,\r\n        prepaidCount,\r\n        pendingCount,\r\n        recent: recentOrders.map(o => ({\r\n          id: o.id,\r\n          name: o.name,\r\n          total: parseFloat(o.total_price),\r\n          status: o.financial_status,\r\n          createdAt: o.created_at,\r\n        })),\r\n      },\r\n      refunds: {\r\n        total: refunds.length,\r\n        recent: refunds.slice(0, 10),\r\n      },\r\n    };\r\n\r\n    return new Response(JSON.stringify({ dashboard }), {\r\n      status: 200,\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Dashboard fetch error:\", err);\r\n    return new Response(\r\n      JSON.stringify({ error: \"Failed to fetch dashboard data\", details: err.message }),\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/lib/db.js"],"sourcesContent":["\r\n// /lib/db.js\r\nimport mongoose from \"mongoose\";\r\n\r\nlet isConnected = false;\r\n\r\nexport default async function connectDB() {\r\n  if (isConnected) return;\r\n\r\n  if (!process.env.MONGODB_URI) {\r\n    throw new Error(\"❌ MONGODB_URI is missing in .env.local\");\r\n  }\r\n\r\n  try {\r\n    const db = await mongoose.connect(process.env.MONGODB_URI, {\r\n      dbName: \"shopify-app\",\r\n    });\r\n    isConnected = db.connections[0].readyState === 1;\r\n    console.log(\"✅ Database connected\");\r\n  } catch (err) {\r\n    console.error(\"❌ Database connection error:\", err);\r\n    throw err;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AACA,aAAa;;;;;AACb;;AAEA,IAAI,cAAc;AAEH,eAAe;IAC5B,IAAI,aAAa;IAEjB,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;QAC5B,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,MAAM,KAAK,MAAM,oHAAQ,CAAC,OAAO,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;YACzD,QAAQ;QACV;QACA,cAAc,GAAG,WAAW,CAAC,EAAE,CAAC,UAAU,KAAK;QAC/C,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,MAAM;IACR;AACF"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/models/User.js"],"sourcesContent":["\r\nimport mongoose from \"mongoose\";\r\n\r\nconst UserSchema = new mongoose.Schema(\r\n  {\r\n    adminName: String,\r\n    email: { type: String, unique: true },\r\n    shopName: String,\r\n    shopUrl: String,\r\n    accessToken: String,\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nexport default mongoose.models.User || mongoose.model(\"User\", UserSchema);\r\n\r\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CACpC;IACE,WAAW;IACX,OAAO;QAAE,MAAM;QAAQ,QAAQ;IAAK;IACpC,UAAU;IACV,SAAS;IACT,aAAa;AACf,GACA;IAAE,YAAY;AAAK;uCAGN,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ"}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/lib/jwt.js"],"sourcesContent":["\r\n\r\n\r\n\r\nimport jwt from \"jsonwebtoken\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || \"your_super_secret_key\";\r\n\r\n// Generate a token\r\nexport function signToken(payload, expiresIn = \"1h\") {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn });\r\n}\r\n\r\n// Verify a token\r\nexport function verifyToken(token) {\r\n  try {\r\n    return jwt.verify(token, JWT_SECRET);\r\n  } catch (err) {\r\n    return null;\r\n  }\r\n}\r\n  "],"names":[],"mappings":";;;;;;AAIA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAGtC,SAAS,UAAU,OAAO,EAAE,YAAY,IAAI;IACjD,OAAO,gKAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE;IAAU;AACnD;AAGO,SAAS,YAAY,KAAK;IAC/B,IAAI;QACF,OAAO,gKAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,KAAK;QACZ,OAAO;IACT;AACF"}},
    {"offset": {"line": 152, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Desktop/next-shiprocket/shiprocket/src/app/api/customer/route.js"],"sourcesContent":["export const dynamic = \"force-dynamic\";\r\n\r\nimport connectToDB  from \"@/lib/db\";\r\nimport User from \"@/models/User\";\r\nimport { verifyToken } from \"@/lib/jwt\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nconst CUSTOMER_BATCH_SIZE = 50; // customers per request\r\nconst ORDER_BATCH_SIZE = 50;    // orders per request\r\n\r\nexport async function GET(req) {\r\n  await connectToDB();\r\n\r\n  // 1️⃣ Auth\r\n  const authHeader = req.headers.get(\"authorization\");\r\n  if (!authHeader) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const token = authHeader.split(\" \")[1];\r\n  const decoded = verifyToken(token);\r\n  if (!decoded) return NextResponse.json({ error: \"Invalid token\" }, { status: 401 });\r\n\r\n  // 2️⃣ Get admin\r\n  const admin = await User.findOne({ email: decoded.email }).select(\"+accessToken +shopUrl\");\r\n  if (!admin) return NextResponse.json({ error: \"Admin not found\" }, { status: 404 });\r\n  if (!admin.accessToken || !admin.shopUrl)\r\n    return NextResponse.json({ error: \"Shopify credentials missing\" }, { status: 400 });\r\n\r\n  const allCustomers = [];\r\n  let customerCursor = null;\r\n\r\n  try {\r\n    // 3️⃣ Paginate through all customers\r\n    while (true) {\r\n      const customersQuery = {\r\n        query: `\r\n          {\r\n            customers(first: ${CUSTOMER_BATCH_SIZE}${customerCursor ? `, after: \"${customerCursor}\"` : \"\"}) {\r\n              pageInfo {\r\n                hasNextPage\r\n                endCursor\r\n              }\r\n              edges {\r\n                node {\r\n                  id\r\n                  email\r\n                  firstName\r\n                  lastName\r\n                  orders(first: ${ORDER_BATCH_SIZE}) {\r\n                    edges {\r\n                      node {\r\n                        currentTotalPriceSet {\r\n                          presentmentMoney {\r\n                            amount\r\n                            currencyCode\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                    pageInfo {\r\n                      hasNextPage\r\n                      endCursor\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        `\r\n      };\r\n\r\n      const resp = await fetch(`https://${admin.shopUrl}/admin/api/2025-10/graphql.json`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"X-Shopify-Access-Token\": admin.accessToken,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(customersQuery),\r\n      });\r\n\r\n      const data = await resp.json();\r\n\r\n      if (data.errors) {\r\n        return NextResponse.json({ error: \"Shopify GraphQL returned errors\", details: data.errors }, { status: 500 });\r\n      }\r\n\r\n      const customersBatch = data.data.customers.edges.map(edge => edge.node);\r\n\r\n      // 4️⃣ Process each customer\r\n      const processedCustomers = await Promise.all(\r\n        customersBatch.map(async (c) => {\r\n          let ordersCount = c.orders.edges.length;\r\n          let totalSpent = c.orders.edges.reduce(\r\n            (sum, o) => sum + parseFloat(o.node.currentTotalPriceSet.presentmentMoney.amount),\r\n            0\r\n          );\r\n          let currency = c.orders.edges[0]?.node.currentTotalPriceSet.presentmentMoney.currencyCode || \"\";\r\n\r\n          // Handle pagination for orders if more than ORDER_BATCH_SIZE\r\n          let orderCursor = c.orders.pageInfo.endCursor;\r\n          while (c.orders.pageInfo.hasNextPage && orderCursor) {\r\n            const ordersQuery = {\r\n              query: `\r\n                {\r\n                  customer(id: \"${c.id}\") {\r\n                    orders(first: ${ORDER_BATCH_SIZE}, after: \"${orderCursor}\") {\r\n                      edges {\r\n                        node {\r\n                          currentTotalPriceSet {\r\n                            presentmentMoney {\r\n                              amount\r\n                              currencyCode\r\n                            }\r\n                          }\r\n                        }\r\n                      }\r\n                      pageInfo {\r\n                        hasNextPage\r\n                        endCursor\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              `\r\n            };\r\n\r\n            const ordersResp = await fetch(`https://${admin.shopUrl}/admin/api/2025-10/graphql.json`, {\r\n              method: \"POST\",\r\n              headers: {\r\n                \"X-Shopify-Access-Token\": admin.accessToken,\r\n                \"Content-Type\": \"application/json\",\r\n              },\r\n              body: JSON.stringify(ordersQuery),\r\n            });\r\n\r\n            const ordersData = await ordersResp.json();\r\n            const orderEdges = ordersData.data.customer.orders.edges;\r\n\r\n            ordersCount += orderEdges.length;\r\n            totalSpent += orderEdges.reduce(\r\n              (sum, o) => sum + parseFloat(o.node.currentTotalPriceSet.presentmentMoney.amount),\r\n              0\r\n            );\r\n\r\n            orderCursor = ordersData.data.customer.orders.pageInfo.endCursor;\r\n            if (!ordersData.data.customer.orders.pageInfo.hasNextPage) break;\r\n          }\r\n\r\n          return {\r\n            id: c.id,\r\n            email: c.email,\r\n            firstName: c.firstName || \"\",\r\n            lastName: c.lastName || \"\",\r\n            ordersCount,\r\n            totalSpent,\r\n            currency,\r\n          };\r\n        })\r\n      );\r\n\r\n      allCustomers.push(...processedCustomers);\r\n\r\n      if (!data.data.customers.pageInfo.hasNextPage) break;\r\n      customerCursor = data.data.customers.pageInfo.endCursor;\r\n    }\r\n\r\n    return NextResponse.json({ customers: allCustomers });\r\n  } catch (err) {\r\n    return NextResponse.json({ error: \"Failed to fetch Shopify customers\", details: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}